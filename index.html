<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Web GIS RTRW Kota Bitung</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }

        /* --- 1. SEARCH BAR (Modern & Mobile Friendly) --- */
        .search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            display: flex;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 25px 0 0 25px;
            font-size: 14px;
            outline: none;
        }
        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 0 25px 25px 0;
            cursor: pointer;
        }
        .search-btn:hover { background: #0056b3; }

        /* --- 2. TOMBOL GPS (Floating Action Button) --- */
        .btn-gps {
            position: absolute;
            bottom: 40px; /* Posisi di atas atribusi map */
            right: 15px;
            z-index: 900;
            background: white;
            color: #444;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        .btn-gps:active { background: #f0f0f0; transform: scale(0.95); }
        .btn-gps.loading { color: #007bff; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- 3. LEGENDA (Collapsible/Bisa Dilipat) --- */
        .legend-control {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            max-width: 250px;
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 25px; /* Jarak dari bawah agar tidak menabrak tombol zoom di desktop */
        }
        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 5px;
            cursor: pointer;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .legend-content {
            max-height: 250px;
            overflow-y: auto;
            display: block;
            transition: all 0.3s ease;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-color {
            width: 18px; height: 18px; 
            margin-right: 8px; 
            border-radius: 3px;
            opacity: 0.8;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* --- 4. POPUP STYLE --- */
        .popup-content h4 { margin: 0 0 5px 0; color: #007bff; }
        .popup-content table { width: 100%; font-size: 13px; border-collapse: collapse; }
        .popup-content td { padding: 3px 0; vertical-align: top; }
        .popup-key { color: #666; width: 80px; }

        /* --- 5. MOBILE TWEAKS --- */
        @media (max-width: 600px) {
            .leaflet-control-zoom { display: none; } /* Hilangkan tombol zoom +/- di HP */
            .legend-content { display: none; } /* Default tertutup di HP */
            .legend-content.show { display: block; }
            .legend-control { width: 200px; margin-left: 10px !important; margin-bottom: 80px !important; }
            .btn-gps { bottom: 90px; } /* Naik sedikit agar tidak tertutup */
    
        /* TEMPELKAN KODE ITU DISINI (PALING BAWAH DALAM STYLE) */
        .leaflet-top.leaflet-right {
            top: 70px !important; /* Saya set 70px agar pas di bawah Search Bar */
        }
    </style>
</head>
<body>

    <div class="search-container">
        <input type="text" class="search-input" id="coordInput" placeholder="Cari Koordinat (Lat, Long)...">
        <button class="search-btn" onclick="cariKoordinat()"><i class="fas fa-search"></i></button>
    </div>

    <button class="btn-gps" onclick="cariLokasi()" title="Lokasi Saya">
        <i class="fas fa-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. BASEMAPS (Peta Dasar) ---
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap', maxZoom: 19
        });

        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '© Google Map'
        });

        var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '© Google Map'
        });

        var map = L.map('map', {
            center: [1.445, 125.15], 
            zoom: 12,
            layers: [osmLayer], 
            zoomControl: false 
        });

        // Layer Control
        var baseMaps = {
            "Peta Jalan": osmLayer,
            "Satelit (Polos)": googleSat,
            "Satelit (Label)": googleHybrid
        };
        L.control.layers(baseMaps).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- 2. PEWARNAAN LENGKAP (LOGIKA UTAMA) ---
        // Warna diambil berdasarkan standar umum RTRW di Indonesia
        function getColor(pola) {
            if (!pola) return '#808080';
            
            // Tips: String matching kita buat agar tidak sensitif huruf besar/kecil jika perlu
            // Tapi di sini kita pakai exact match sesuai data GeoJSON umumnya.
            
            switch (pola) {
                // --- KAWASAN LINDUNG (HIJAU/BIRU) ---
                case 'Kawasan Hutan Lindung':           return '#228B22'; // ForestGreen
                case 'Hutan Lindung':                   return '#228B22';
                case 'Hutan Produksi Terbatas':         return '#3CB371'; // MediumSeaGreen
                case 'Hutan Produksi Tetap':            return '#2E8B57'; // SeaGreen
                case 'Cagar Alam':                      return '#006400'; // DarkGreen
                case 'Suaka Alam':                      return '#006400';
                case 'Taman Wisata Alam':               return '#32CD32'; // LimeGreen
                case 'RTH':                             return '#7CFC00'; // LawnGreen
                case 'Resapan Air':                     return '#98FB98'; // PaleGreen
                case 'Sempadan Sungai dan Pantai':      return '#00FA9A'; // MediumSpringGreen
                case 'Kawasan Wilayah Pesisir dan Pulau Kecil': return '#40E0D0'; // Turquoise
                case 'Bakau':                           return '#008080'; // Teal
                case 'Mangrove':                        return '#008080';

                // --- KAWASAN PERMUKIMAN (KUNING/ORANYE) ---
                case 'Kawasan Permukiman':              return '#FFFF00'; // Yellow (Standar)
                case 'Perumahan':                       return '#FFFF00';
                case 'Permukiman Perkotaan':            return '#FFD700'; // Gold
                case 'Permukiman Pedesaan':             return '#F0E68C'; // Khaki

                // --- EKONOMI & BISNIS (MERAH/UNGU/PINK) ---
                case 'Perdagangan dan Jasa':            return '#FF0000'; // Red (Standar)
                case 'Kawasan Industri':                return '#8B0000'; // DarkRed
                case 'Pergudangan':                     return '#800000'; // Maroon
                case 'Perkantoran':                     return '#8A2BE2'; // BlueViolet
                case 'Pendidikan':                      return '#FF1493'; // DeepPink
                case 'Kesehatan':                       return '#FF69B4'; // HotPink
                case 'Pariwisata':                      return '#FFC0CB'; // Pink

                // --- TRANSPORTASI (MERAH DARAH) ---
                case 'Transportasi':                    return '#DC143C'; // Crimson
                case 'Pelabuhan Laut':                  return '#0000CD'; // MediumBlue
                case 'Bandar Udara':                    return '#1E90FF'; // DodgerBlue
                case 'Terminal':                        return '#B22222'; // FireBrick

                // --- PERTANIAN (KUNING KEHIJAUAN/COKLAT) ---
                case 'Pertanian':                       return '#BDB76B'; // DarkKhaki
                case 'Pertanian Lahan Kering':          return '#DAA520'; // GoldenRod
                case 'Pertanian Lahan Basah':           return '#9ACD32'; // YellowGreen
                case 'Perkebunan':                      return '#CD853F'; // Peru
                case 'Perikanan':                       return '#F4A460'; // SandyBrown

                // --- ENERGI & TAMBANG (ABU/COKLAT TUA) ---
                case 'Pertambangan Mineral dan Batubara': return '#A0522D'; // Sienna
                case 'Pembangkit Tenaga Listrik':       return '#708090'; // SlateGray
                
                // --- HANKAM (UNGU TUA) ---
                case 'Pertahanan dan Keamanan':         return '#4B0082'; // Indigo
                case 'Militer':                         return '#4B0082';

                case 'Badan Air':                       return '#00BFFF'; // DeepSkyBlue
                
                // Default jika tidak dikenali
                default: 
                    // console.log("Missing Color for: " + pola); // Untuk debugging
                    return '#808080'; 
            }
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.POLA_RUANG),
                weight: 1,
                opacity: 1,
                color: 'white', // Garis pinggir putih tipis
                dashArray: '3',
                fillOpacity: 0.65 // Sedikit transparan agar basemap terlihat samar
            };
        }

        function onEachFeature(feature, layer) {
            if (feature.properties) {
                var content = `
                    <div class="popup-content">
                        <h4>${feature.properties.POLA_RUANG || "Zona Tidak Diketahui"}</h4>
                        <table>
                            <tr><td class="popup-key">Kategori</td><td>: ${feature.properties.KAWASAN_LI || "-"}</td></tr>
                            <tr><td class="popup-key">Luas</td><td>: ${feature.properties.Hectares ? feature.properties.Hectares.toFixed(2) + ' Ha' : '-'}</td></tr>
                        </table>
                    </div>
                `;
                layer.bindPopup(content);
            }
        }

        // --- 3. LOAD DATA ---
        fetch('rtrw_fix.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, { style: style, onEachFeature: onEachFeature }).addTo(map);
            })
            .catch(err => console.error("Error loading GeoJSON:", err));

        // --- 4. LEGENDA DINAMIS ---
        var legend = L.control({position: 'bottomleft'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend-control');
            
            // Kita buat array kategori untuk Legenda agar urutannya rapi
            var legendItems = [
                {label: 'Kawasan Hutan Lindung', color: getColor('Kawasan Hutan Lindung')},
                {label: 'RTH / Resapan Air', color: getColor('RTH')},
                {label: 'Kawasan Permukiman', color: getColor('Kawasan Permukiman')},
                {label: 'Perdagangan & Jasa', color: getColor('Perdagangan dan Jasa')},
                {label: 'Perkantoran', color: getColor('Perkantoran')},
                {label: 'Kawasan Industri', color: getColor('Kawasan Industri')},
                {label: 'Pertanian/Perkebunan', color: getColor('Pertanian')},
                {label: 'Pariwisata', color: getColor('Pariwisata')},
                {label: 'Pelabuhan/Bandara', color: getColor('Bandar Udara')},
                {label: 'Pertahanan Keamanan', color: getColor('Pertahanan dan Keamanan')}
            ];
            
            var html = `
                <div class="legend-header" onclick="toggleLegend()">
                    <span>Legenda Pola Ruang</span>
                    <i id="legend-icon" class="fas fa-chevron-down"></i>
                </div>
                <div class="legend-content" id="legend-content">
            `;

            legendItems.forEach(item => {
                html += `
                    <div class="legend-item">
                        <div class="legend-color" style="background:${item.color}"></div>
                        <span>${item.label}</span>
                    </div>`;
            });
            
            html += `</div>`;
            div.innerHTML = html;
            return div;
        };
        legend.addTo(map);

        function toggleLegend() {
            var content = document.getElementById('legend-content');
            var icon = document.getElementById('legend-icon');
            
            if (content.style.display === "block" || content.classList.contains('show')) {
                content.classList.remove('show');
                content.style.display = "none";
                icon.className = "fas fa-chevron-down";
            } else {
                content.classList.add('show');
                content.style.display = "block";
                icon.className = "fas fa-chevron-up";
            }
        }

        // --- 5. LOGIKA PENCARIAN & GPS ---
        var searchMarker;
        function cariKoordinat() {
            var input = document.getElementById('coordInput').value;
            // Membersihkan input dari spasi yang mungkin tidak sengaja tercopy
            var cleanInput = input.replace(/\s/g, ''); 
            var coords = cleanInput.split(',');

            if (coords.length === 2) {
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);

                if (!isNaN(lat) && !isNaN(lng)) {
                    if (searchMarker) map.removeLayer(searchMarker);
                    searchMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup("<b>Lokasi Pencarian</b><br>" + lat + ", " + lng).openPopup();
                    map.flyTo([lat, lng], 18); // Zoom level dekat
                } else {
                    alert("Koordinat tidak valid! Pastikan format angka benar.");
                }
            } else {
                alert("Format salah! Gunakan: Latitude,Longitude (Contoh: 1.445,125.15)");
            }
        }

        var userMarker, userCircle;
        function cariLokasi() {
            var btn = document.querySelector('.btn-gps');
            btn.classList.add('loading');
            map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true});
        }

        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            if (userMarker) map.removeLayer(userMarker);
            if (userCircle) map.removeLayer(userCircle);
            
            userMarker = L.marker(e.latlng).addTo(map).bindPopup("Posisi Anda").openPopup();
            userCircle = L.circle(e.latlng, radius).addTo(map);
            document.querySelector('.btn-gps').classList.remove('loading');
        }

        function onLocationError(e) {
            alert("Gagal mendeteksi lokasi. Pastikan GPS aktif.");
            document.querySelector('.btn-gps').classList.remove('loading');
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

    </script>
</body>
</html>




