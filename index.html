<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Web GIS RTRW Kota Bitung</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }

        /* --- SEARCH BAR --- */
        .search-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px;
            display: flex; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .search-input {
            width: 100%; padding: 12px 15px; border: none;
            border-radius: 25px 0 0 25px; font-size: 14px; outline: none;
        }
        .search-btn {
            background: #007bff; color: white; border: none;
            padding: 0 20px; border-radius: 0 25px 25px 0; cursor: pointer;
        }

        /* --- TOMBOL GPS --- */
        .btn-gps {
            position: absolute; bottom: 40px; right: 15px; z-index: 900;
            background: white; color: #444; width: 50px; height: 50px;
            border-radius: 50%; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .btn-gps.loading { color: #007bff; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- LEGENDA --- */
        .legend-control {
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); max-width: 250px;
            font-size: 12px; line-height: 1.5; margin-bottom: 25px;
        }
        .legend-header {
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; margin-bottom: 5px; cursor: pointer;
            padding-bottom: 5px; border-bottom: 1px solid #eee;
        }
        .legend-content { max-height: 250px; overflow-y: auto; display: block; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-color { width: 18px; height: 18px; margin-right: 8px; border: 1px solid #ccc; flex-shrink: 0; }

        /* --- CSS KHUSUS --- */
        .leaflet-top.leaflet-right { top: 70px !important; }
        .popup-content h4 { margin: 0 0 5px 0; color: #333; font-weight: bold; }
        .popup-content table { width: 100%; font-size: 13px; }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .leaflet-control-zoom { display: none; }
            .legend-content { display: none; }
            .legend-content.show { display: block; }
            .legend-control { width: 200px; margin-left: 10px !important; margin-bottom: 80px !important; }
            .btn-gps { bottom: 90px; }
        }
    </style>
</head>
<body>

    <div class="search-container">
        <input type="text" class="search-input" id="coordInput" placeholder="Cari Koordinat (Lat, Long)...">
        <button class="search-btn" onclick="cariKoordinat()"><i class="fas fa-search"></i></button>
    </div>

    <button class="btn-gps" onclick="cariLokasi()" title="Lokasi Saya">
        <i class="fas fa-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. BASEMAPS ---
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap', maxZoom: 19
        });
        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '© Google Map'
        });
        var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '© Google Map'
        });

        var map = L.map('map', {
            center: [1.445, 125.15], zoom: 12, layers: [osmLayer], zoomControl: false 
        });

        var baseMaps = { "Peta Jalan": osmLayer, "Satelit (Polos)": googleSat, "Satelit (Label)": googleHybrid };
        L.control.layers(baseMaps).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- 2. PEWARNAAN (Custom dengan Penggabungan Pertanian/Perkebunan) ---
        function getColor(pola) {
            if (!pola) return '#F0F0F0';
            var p = pola.trim(); 

            switch (p) {
                // === 1. PERTANIAN & PERKEBUNAN (DIGABUNG) ===
                case 'Pertanian':
                case 'Pertanian Lahan Basah':
                case 'Pertanian Lahan Kering':
                case 'Perkebunan':
                case 'Kawasan Pertanian':
                    return '#D9E37D'; // Kuning Kehijauan (Gabungan)

                // === 2. KAWASAN LINDUNG ===
                case 'Kawasan Hutan Lindung':           return '#1E8F53'; 
                case 'Hutan Lindung':                   return '#1E8F53';
                case 'Hutan Produksi Terbatas':         return '#5CA973';
                case 'Hutan Produksi Tetap':            return '#7BBD8B'; 
                case 'Cagar Alam':                      return '#4D084C'; 
                case 'Taman Wisata Alam':               return '#38A800';
                case 'RTH':                             return '#89CD66'; 
                case 'Resapan Air':                     return '#A3E39B'; 
                case 'Sempadan Sungai dan Pantai':      return '#99FF99';
                case 'Bakau':                           return '#28583B'; 
                case 'Mangrove':                        return '#28583B';

                // === 3. PERMUKIMAN ===
                case 'Kawasan Permukiman':              return '#F6E125'; 
                case 'Perumahan':                       return '#F6E125'; 
                case 'Permukiman Perkotaan':            return '#F3A932'; 
                case 'Permukiman Pedesaan':             return '#F6E125'; 

                // === 4. EKONOMI & BISNIS ===
                case 'Perdagangan dan Jasa':            return '#E60000'; 
                case 'Kawasan Industri':                return '#FF7F00'; 
                case 'Perkantoran':                     return '#A75196'; 
                case 'Pariwisata':                      return '#FF99CC'; 
                case 'Perikanan':                       return '#6EB5C0'; 

                // === 5. INFRASTRUKTUR & LAINNYA ===
                case 'Transportasi':                    return '#C4061B'; 
                case 'Pelabuhan Laut':                  return '#005CE6'; 
                case 'Bandar Udara':                    return '#005CE6'; 
                case 'Pertahanan dan Keamanan':         return '#4C0073'; 
                case 'Pertambangan Mineral dan Batubara': return '#594F4F'; 
                case 'Pembangkit Tenaga Listrik':       return '#594F4F';
                
                default: return '#EBE5D9'; 
            }
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.POLA_RUANG),
                weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
            };
        }

        function onEachFeature(feature, layer) {
            if (feature.properties) {
                var content = `
                    <div class="popup-content">
                        <h4>${feature.properties.POLA_RUANG || "Zona"}</h4>
                        <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
                        <table>
                            <tr><td style="color:#666">Kategori</td><td>: <b>${feature.properties.KAWASAN_LI || "-"}</b></td></tr>
                            <tr><td style="color:#666">Luas</td><td>: <b>${feature.properties.Hectares ? feature.properties.Hectares.toFixed(2) + ' Ha' : '-'}</b></td></tr>
                        </table>
                    </div>
                `;
                layer.bindPopup(content);
            }
        }

        // --- LOAD DATA ---
        fetch('rtrw_fix.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, { style: style, onEachFeature: onEachFeature }).addTo(map);
            })
            .catch(err => console.error("Error loading GeoJSON:", err));

        // --- LEGENDA (Diperlengkap sesuai request) ---
        var legend = L.control({position: 'bottomleft'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend-control');
            
            // Daftar Item Legenda yang LEBIH LENGKAP
            var legendItems = [
                {label: 'Kawasan Hutan Lindung', color: getColor('Kawasan Hutan Lindung')},
                {label: 'Hutan Produksi', color: getColor('Hutan Produksi Tetap')},
                {label: 'RTH / Resapan Air', color: getColor('RTH')},
                // Item Gabungan Baru
                {label: 'Pertanian / Perkebunan', color: getColor('Pertanian')},
                {label: 'Perikanan', color: getColor('Perikanan')},
                {label: 'Permukiman', color: getColor('Perumahan')},
                {label: 'Perdagangan & Jasa', color: getColor('Perdagangan dan Jasa')},
                {label: 'Kawasan Industri', color: getColor('Kawasan Industri')},
                {label: 'Perkantoran', color: getColor('Perkantoran')},
                {label: 'Pariwisata', color: getColor('Pariwisata')},
                {label: 'Transportasi (Laut/Udara)', color: getColor('Bandar Udara')},
                {label: 'Pertahanan Keamanan', color: getColor('Pertahanan dan Keamanan')},
                {label: 'Energi / Pertambangan', color: getColor('Pembangkit Tenaga Listrik')}
            ];
            
            var html = `
                <div class="legend-header" onclick="toggleLegend()">
                    <span>Legenda Pola Ruang</span>
                    <i id="legend-icon" class="fas fa-chevron-down"></i>
                </div>
                <div class="legend-content" id="legend-content">
            `;
            legendItems.forEach(item => {
                html += `
                    <div class="legend-item">
                        <div class="legend-color" style="background:${item.color}"></div>
                        <span>${item.label}</span>
                    </div>`;
            });
            html += `</div>`;
            div.innerHTML = html;
            return div;
        };
        legend.addTo(map);

        function toggleLegend() {
            var content = document.getElementById('legend-content');
            var icon = document.getElementById('legend-icon');
            if (content.style.display === "block" || content.classList.contains('show')) {
                content.classList.remove('show'); content.style.display = "none"; icon.className = "fas fa-chevron-down";
            } else {
                content.classList.add('show'); content.style.display = "block"; icon.className = "fas fa-chevron-up";
            }
        }

        // --- LOGIKA PENCARIAN & GPS ---
        var searchMarker;
        function cariKoordinat() {
            var input = document.getElementById('coordInput').value.replace(/\s/g, ''); 
            var coords = input.split(',');
            if (coords.length === 2) {
                var lat = parseFloat(coords[0]); var lng = parseFloat(coords[1]);
                if (!isNaN(lat) && !isNaN(lng)) {
                    if (searchMarker) map.removeLayer(searchMarker);
                    searchMarker = L.marker([lat, lng]).addTo(map).bindPopup("Lokasi Pencarian").openPopup();
                    map.flyTo([lat, lng], 17);
                } else { alert("Koordinat tidak valid!"); }
            } else { alert("Format: Latitude,Longitude"); }
        }

        var userMarker, userCircle;
        function cariLokasi() {
            var btn = document.querySelector('.btn-gps');
            btn.classList.add('loading');
            map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true});
        }
        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            if (userMarker) map.removeLayer(userMarker);
            if (userCircle) map.removeLayer(userCircle);
            userMarker = L.marker(e.latlng).addTo(map).bindPopup("Posisi Anda").openPopup();
            userCircle = L.circle(e.latlng, radius).addTo(map);
            document.querySelector('.btn-gps').classList.remove('loading');
        }
        function onLocationError(e) {
            alert("Gagal mendeteksi lokasi.");
            document.querySelector('.btn-gps').classList.remove('loading');
        }
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
    </script>
</body>
</html>
